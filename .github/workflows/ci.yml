name: ci

on:
  push:
  pull_request:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies (canonical)
        run: |
          make install-uv

      - name: Verify lock file is up-to-date
        run: |
          export VIRTUAL_ENV="${PWD}/.venv"
          .venv/bin/uv lock --check

      - name: Validate .venv policy (Gate 0)
        run: |
          .venv/bin/python tools/validate_dotvenv_policy.py

      - name: Ruff
        run: |
          .venv/bin/python -m ruff check .
          .venv/bin/python -m ruff format --check .

      - name: Spec pack validation
        run: |
          .venv/bin/python scripts/validate_spec_pack.py

      - name: Plans validation
        run: |
          .venv/bin/python scripts/validate_plans.py

      - name: Install package (for console script tests)
        run: |
          .venv/bin/pip install -e .

      - name: Tests (enforce zero skips)
        run: |
          # Run tests with verbose output
          .venv/bin/python -m pytest -v | tee pytest_output.txt

          # Fail if any tests were skipped
          if grep -iq "skipped" pytest_output.txt; then
            echo "ERROR: Tests were skipped (not allowed in CI per Phase 8)"
            echo "All tests must pass without skips for strict compliance"
            exit 1
          fi

          echo "SUCCESS: All tests passed with zero skips"

      - name: Windows reserved names gate (Gate S)
        run: |
          .venv/bin/python tools/validate_windows_reserved_names.py

      - name: Swarm readiness validation (all gates)
        run: |
          .venv/bin/python tools/validate_swarm_ready.py
