# Contributing

This repository is a **spec pack + scaffold** for an agent-executed system that launches GitHub product repositories onto Hugo-based websites.

## Ground Rules

### Spec Authority
- **Do not change binding specs casually**. Changes to `specs/` must be deliberate and reviewed.
- Keep implementation aligned to specs. If implementation diverges, update specs or fix code.
- Binding specs (see [specs/README.md](specs/README.md)) require taskcard coverage and tests.
- Reference docs (see [docs/README.md](docs/README.md)) are informative only.

### No Manual Edits During Launches
- No manual content edits in target site repos during launches (see `plans/policies/no_manual_content_edits.md`).
- All site content must be generated by workers and validated by gates.

### Auditability
- All agent work must be auditable: write reports to `reports/` and runs to `runs/`.
- Every taskcard execution requires: `plan.md`, `changes.md`, `evidence.md`, `self_review.md`, `commands.sh`, `artifacts/`
- See [reports/README.md](reports/README.md) for evidence requirements.

### Virtual Environment Policy (MANDATORY)
- **MUST use**: `.venv/` at repository root (see [specs/00_environment_policy.md](specs/00_environment_policy.md))
- **FORBIDDEN**: Any other virtual environment name (venv/, env/, .tox/, etc.)
- **FORBIDDEN**: Using global/system Python for development or testing
- **Enforcement**: Automated gates fail if policy is violated

All developers, agents, and CI must use `.venv` explicitly.

## Development Quickstart

### Prerequisites
- Python >= 3.12
- [uv](https://docs.astral.sh/uv/) (preferred for deterministic installs)
- Git

### Initial Setup

**Preferred (deterministic with uv into .venv):**
```bash
# Install uv if not present: https://docs.astral.sh/uv/getting-started/installation/
make install-uv

# Activate .venv
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate
```

**Fallback (non-deterministic with pip into .venv):**
```bash
make install

# Activate .venv
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate
```

**Important**: Always activate `.venv` before running commands. The Makefile and CI enforce `.venv` usage automatically.

### Validation

From activated `.venv`:

```bash
# Run preflight validation (ensures repository is swarm-ready)
python tools/validate_swarm_ready.py

# Validate the spec pack itself (schemas, pinned pilot configs, toolchain lock)
make validate

# Run linters
make lint

# Run tests (when implemented)
make test
```

### Common Development Tasks

```bash
# Check markdown link integrity
python tools/check_markdown_links.py

# Validate all taskcard YAML frontmatter
python tools/validate_taskcards.py

# Generate/regenerate STATUS_BOARD
python tools/generate_status_board.py

# Audit allowed_paths for overlaps
python tools/audit_allowed_paths.py

# Generate forensics catalog (file tree + SHA256 hashes)
python scripts/forensics_catalog.py
```

## Adding New Content

### Adding a New Spec

1. **Determine if it should be binding**:
   - **BINDING**: Defines contracts, workflows, runtime behavior that must be enforced
   - **REFERENCE**: Informational, guides implementation but not enforced

2. **Create the spec file**:
   - Location: `specs/<number>_<name>.md`
   - Follow existing numbering (00-34)
   - Use clear, imperative language (SHALL/MUST/MUST_NOT for binding specs)

3. **Update spec index**:
   - Add entry to [specs/README.md](specs/README.md)
   - Mark as BINDING or REFERENCE

4. **Update traceability**:
   - Add to [plans/traceability_matrix.md](plans/traceability_matrix.md) if BINDING
   - Link to implementing/validating taskcards

5. **Create taskcards** (if BINDING):
   - Create implementation taskcard(s) in `plans/taskcards/`
   - Create validation taskcard(s) or gate coverage
   - Update [plans/taskcards/INDEX.md](plans/taskcards/INDEX.md)

6. **Validate**:
   ```bash
   python tools/check_markdown_links.py
   python scripts/validate_spec_pack.py
   ```

### Adding a New Schema

1. **Create the schema file**:
   - Location: `specs/schemas/<artifact_type>.schema.json`
   - Use JSON Schema Draft 2020-12 format
   - Follow existing naming: snake_case with `.schema.json` suffix

2. **Update schemas README**:
   - Add entry to [specs/schemas/README.md](specs/schemas/README.md)
   - Document primary producer and validators

3. **Update validation tooling**:
   - Add to `scripts/validate_spec_pack.py` if pinned examples exist
   - Update `src/launch/validators/schema.py` if runtime validation needed

4. **Update spec documentation**:
   - Reference schema in relevant spec files
   - Add schema-valid examples in spec text

5. **Validate**:
   ```bash
   # Validate schema is valid JSON Schema
   python -c "
   import json, jsonschema
   schema = json.load(open('specs/schemas/<new_schema>.schema.json'))
   jsonschema.Draft202012Validator.check_schema(schema)
   print('Schema is valid')
   "

   # Validate spec pack
   python scripts/validate_spec_pack.py
   ```

### Adding a New Taskcard

1. **Create taskcard file**:
   - Location: `plans/taskcards/TC-<number>_<slug>.md`
   - Use next available TC number
   - Include YAML frontmatter (see [plans/taskcards/00_TASKCARD_CONTRACT.md](plans/taskcards/00_TASKCARD_CONTRACT.md))

2. **Define frontmatter** (MANDATORY):
   ```yaml
   ---
   taskcard_id: TC-XXX
   title: "Brief description"
   owner: null
   status: Ready
   priority: P1
   wave: 9
   estimated_hours: 2-4
   depends_on: []
   spec_refs: ["specs/XX_spec.md"]
   allowed_paths:
     - "path/to/implementation/**"
   evidence_required:
     - "Description of required evidence"
   acceptance_tests:
     - "Description of required test"
   ---
   ```

3. **Update taskcard index**:
   - Run `python tools/generate_status_board.py`
   - Verify entry appears in [plans/taskcards/STATUS_BOARD.md](plans/taskcards/STATUS_BOARD.md)

4. **Update traceability**:
   - Add to [plans/traceability_matrix.md](plans/traceability_matrix.md)
   - Link to spec references

5. **Validate**:
   ```bash
   python tools/validate_taskcards.py
   python tools/audit_allowed_paths.py  # Check for path conflicts
   ```

### Adding Documentation

1. **Determine location**:
   - **Binding specs**: `specs/`
   - **Reference docs**: `docs/`
   - **Reports/evidence**: `reports/`

2. **Create file**:
   - Use `.md` extension
   - Follow existing style (see style guide in relevant README)

3. **Update index**:
   - Add entry to relevant README ([specs/README.md](specs/README.md), [docs/README.md](docs/README.md), or [reports/README.md](reports/README.md))

4. **Cross-reference**:
   - Link from related specs/docs
   - Use relative paths for internal links

5. **Validate links**:
   ```bash
   python tools/check_markdown_links.py
   ```

## Pull Request Process

### Before Opening a PR

1. **Validate locally**:
   ```bash
   # Run preflight validation (Gate 0-K)
   python tools/validate_swarm_ready.py

   # Validate spec pack
   python scripts/validate_spec_pack.py

   # Check markdown links
   python tools/check_markdown_links.py

   # Validate taskcards (if changed)
   python tools/validate_taskcards.py

   # Run linters
   make lint
   ```

2. **Verify .venv usage**:
   ```bash
   # Ensure you're in .venv
   python tools/validate_dotvenv_policy.py
   ```

3. **Write evidence** (for implementation PRs):
   - Create agent report in `reports/agents/<AGENT_NAME>/<TASK_ID>/run_<timestamp>/`
   - Include all 6 required files: `plan.md`, `changes.md`, `evidence.md`, `self_review.md`, `commands.sh`, `artifacts/`
   - Complete 12-dimension self-review (all ≥ 4/5 for PASS)

4. **Update STATUS_BOARD** (for taskcard PRs):
   ```bash
   # Update taskcard frontmatter (set owner, status: In-Progress or Done)
   # Regenerate STATUS_BOARD
   python tools/generate_status_board.py
   ```

### PR Checklist

Use this checklist when opening a PR:

- [ ] **Environment**: All work done in `.venv` (verified with `python tools/validate_dotvenv_policy.py`)
- [ ] **Validation**: Preflight passes (`python tools/validate_swarm_ready.py` exits 0)
- [ ] **Spec Pack**: Spec pack validates (`python scripts/validate_spec_pack.py` exits 0)
- [ ] **Links**: All markdown links valid (`python tools/check_markdown_links.py` exits 0)
- [ ] **Taskcards**: All taskcards validate (if changed) (`python tools/validate_taskcards.py` exits 0)
- [ ] **Linting**: All linters pass (`make lint` exits 0)
- [ ] **Evidence**: Agent report exists with all 6 files (for implementation PRs)
- [ ] **Self-Review**: 12-dimension self-review complete, all ≥ 4/5 (for implementation PRs)
- [ ] **Traceability**: Traceability matrix updated (if specs/taskcards changed)
- [ ] **Breaking Changes**: Breaking changes documented in PR description
- [ ] **Tests**: Tests added/updated (if implementation changed)
- [ ] **Docs**: Documentation updated (if user-facing changes)

### Gate K (Pre-Merge Validation)

Before merging, PR must pass **Gate K** (pre-merge validation):

**Automated Checks**:
- [ ] `.venv` policy enforced (no alternate venvs)
- [ ] Spec pack validates (schemas + pinned configs)
- [ ] Markdown links valid (0 broken links)
- [ ] Taskcards validate (YAML frontmatter correct)
- [ ] Linters pass (ruff, mypy, etc.)
- [ ] No placeholders in committed files (no "TODO", "TBD", "XXX" unless in code comments)

**Manual Review**:
- [ ] Specs updated if contracts changed
- [ ] Traceability matrix updated if specs/taskcards changed
- [ ] Evidence artifacts present for implementation work
- [ ] Self-review shows all dimensions ≥ 4/5
- [ ] No sensitive data committed (credentials, tokens)

**Enforcement**: Gate K is run by CI. PRs cannot merge if Gate K fails.

### Merging

1. **Squash or rebase** (prefer squash for feature branches)
2. **Conventional commit message**:
   - `feat: Add new feature`
   - `fix: Fix bug`
   - `docs: Update documentation`
   - `chore: Maintenance task`
   - `refactor: Code refactoring`
   - `test: Add/update tests`

3. **Reference taskcard** (if applicable):
   ```
   feat: Implement W1 RepoIngester (TC-120)

   - Clone and profile product repos
   - Detect repo archetype
   - Generate repo_inventory.json

   Evidence: reports/agents/AGENT_X/TC-120/run_20260127_120000/
   Self-review: 4.8/5 (all dimensions ≥4/5)
   ```

## Swarm Coordination (Agent Execution)

For parallel agent execution, see:
- [plans/swarm_coordination_playbook.md](plans/swarm_coordination_playbook.md) - Binding swarm rules
- [plans/taskcards/STATUS_BOARD.md](plans/taskcards/STATUS_BOARD.md) - Taskcard status
- [plans/taskcards/00_TASKCARD_CONTRACT.md](plans/taskcards/00_TASKCARD_CONTRACT.md) - Taskcard rules

**Before starting taskcard work**:
1. Verify `.venv` usage: `python tools/validate_dotvenv_policy.py`
2. Find taskcard with `status: Ready` in STATUS_BOARD
3. Verify dependencies are `Done` (check `depends_on` field)
4. Ensure no `allowed_paths` conflict with in-progress taskcards
5. Update taskcard frontmatter: set `owner` and `status: In-Progress`
6. Regenerate STATUS_BOARD: `python tools/generate_status_board.py`

## Questions & Support

- **Open Questions**: [OPEN_QUESTIONS.md](OPEN_QUESTIONS.md)
- **Assumptions**: [ASSUMPTIONS.md](ASSUMPTIONS.md)
- **Design Decisions**: [DECISIONS.md](DECISIONS.md)
- **Glossary**: [GLOSSARY.md](GLOSSARY.md)

For implementation questions, consult binding specs in [specs/](specs/).

---

**Last Updated**: 2026-01-27 (Wave 2 pre-implementation hardening)
