#!/usr/bin/env bash
# FOSS Launcher - AI Agent Governance Hook
# Gate: AG-004 Remote Push Validation
# Purpose: Confirm before pushing new branches to remote

set -e

REMOTE="$1"
URL="$2"

# Read stdin to get refs being pushed
while read local_ref local_sha remote_ref remote_sha
do
    # Extract branch name from ref
    if [[ "$local_ref" =~ refs/heads/(.*) ]]; then
        BRANCH="${BASH_REMATCH[1]}"

        # Check if this is a new branch (remote_sha is all zeros)
        if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
            # New branch being pushed
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ AI GOVERNANCE GATE: AG-004"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "NEW BRANCH PUSH DETECTED"
            echo ""
            echo "Branch: $BRANCH"
            echo "Remote: $REMOTE ($URL)"
            echo "Gate: AG-004 (Remote Push Gate)"
            echo "Severity: WARNING"
            echo ""

            # Check for approval marker
            PUSH_APPROVED=$(git config --get branch."$BRANCH".push-approved || echo "false")

            if [ "$PUSH_APPROVED" != "true" ]; then
                echo "âš ï¸  This branch hasn't been pushed to remote before."
                echo ""
                echo "AI agents should confirm before first push."
                echo ""
                echo "TO APPROVE THIS PUSH:"
                echo "  $ git config branch.$BRANCH.push-approved true"
                echo "  $ git push"
                echo ""
                echo "TO BYPASS THIS CHECK:"
                echo "  $ git config hooks.ai-governance.push-check false"
                echo ""
                echo "See: specs/30_ai_agent_governance.md (Gate AG-004)"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                # Check enforcement mode
                ENFORCE=$(git config --get hooks.ai-governance.push-check || echo "true")

                if [ "$ENFORCE" = "true" ]; then
                    echo ""
                    echo "âŒ PUSH BLOCKED"
                    echo ""
                    exit 1
                else
                    echo ""
                    echo "âš ï¸  WARNING: Enforcement disabled, allowing push"
                    echo ""
                fi
            else
                echo "âœ… Push approved"
                echo ""
            fi
        fi

        # Check for force push (local and remote have diverged)
        if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
            # This would be a force push
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â›” AI GOVERNANCE GATE VIOLATION: AG-003"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "FORCE PUSH DETECTED"
            echo ""
            echo "Branch: $BRANCH"
            echo "Remote: $REMOTE ($URL)"
            echo "Gate: AG-003 (Destructive Git Operations)"
            echo "Severity: BLOCKER"
            echo ""
            echo "Force push would rewrite history and is blocked by AI governance."
            echo ""
            echo "Branches have diverged:"
            echo "  Local:  $local_sha"
            echo "  Remote: $remote_sha"
            echo ""
            echo "TO RESOLVE:"
            echo "1. If you need to force push, use explicit approval:"
            echo "   $ git config branch.$BRANCH.force-push-approved true"
            echo "   $ git push --force-with-lease"
            echo ""
            echo "2. Or merge remote changes first:"
            echo "   $ git pull --rebase"
            echo "   $ git push"
            echo ""
            echo "âš ï¸  NEVER allow AI agents to force push without explicit instruction"
            echo ""
            echo "See: specs/30_ai_agent_governance.md (Gate AG-003)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "âŒ PUSH BLOCKED"
            echo ""
            exit 1
        fi
    fi
done

# ============================================================
# TASKCARD VALIDATION (Pre-Push Gate)
# ============================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” TASKCARD VALIDATION (Pre-Push)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run full taskcard validation (not just staged files)
if python tools/validate_taskcards.py; then
    echo ""
    echo "âœ… All taskcards valid"
else
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â›” TASKCARD VALIDATION FAILED (Pre-Push Gate)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "One or more taskcards have validation errors."
    echo "Fix errors before pushing to remote."
    echo ""
    echo "TO FIX:"
    echo "  1. Review validation errors above"
    echo "  2. Fix taskcard format issues"
    echo "  3. Run: python tools/validate_taskcards.py"
    echo "  4. Commit fixes: git add . && git commit -m 'fix: taskcard validation'"
    echo "  5. Try push again: git push"
    echo ""
    echo "See: plans/taskcards/00_TASKCARD_CONTRACT.md"
    echo ""
    echo "âš ï¸  WARNING: BYPASSING THIS HOOK IS TRACKED BY CI/CD"
    echo ""
    echo "If you use --no-verify, the CI/CD pipeline will:"
    echo "  1. Detect the bypass in your commit message/history"
    echo "  2. Re-validate ALL taskcards (not just staged)"
    echo "  3. BLOCK the PR merge if any taskcard is invalid"
    echo ""
    echo "EMERGENCY BYPASS (tracked and discouraged):"
    echo "  git push --no-verify"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    exit 1
fi

echo ""
echo "âœ… Pre-push governance checks passed"
exit 0
