# Code Changes: Fix URL Path Generation Bug (HEAL-BUG1)

## Summary
Removed section name from URL path computation in `compute_url_path()` function per specs/33_public_url_mapping.md requirement that "Section is implicit in subdomain".

## File 1: src/launch/workers/w4_ia_planner/worker.py

### Change 1: compute_url_path() function (lines 376-410)

**BEFORE**:
```python
def compute_url_path(
    section: str,
    slug: str,
    product_slug: str,
    platform: str = "python",
    locale: str = "en",
) -> str:
    """Compute canonical URL path per specs/33_public_url_mapping.md.

    For V2 layout with default language (en), the URL format is:
    /<family>/<platform>/<section_path>/<slug>/

    Args:
        section: Section name (products, docs, reference, kb, blog)
        slug: Page slug
        product_slug: Product family slug (e.g., "cells", "words")
        platform: Platform (e.g., "python", "java")
        locale: Language code (default: "en")

    Returns:
        Canonical URL path with leading and trailing slashes
    """
    # Per specs/33_public_url_mapping.md:64-66, for default language (en),
    # locale is dropped and platform appears after family
    parts = [product_slug, platform]

    # Add section if not at root
    if section != "products":
        parts.append(section)

    parts.append(slug)

    # Build path with leading and trailing slashes
    url_path = "/" + "/".join(parts) + "/"
    return url_path
```

**AFTER**:
```python
def compute_url_path(
    section: str,
    slug: str,
    product_slug: str,
    platform: str = "python",
    locale: str = "en",
) -> str:
    """Compute canonical URL path per specs/33_public_url_mapping.md.

    Per specs/33_public_url_mapping.md:83-86 and 106:
    - Section is implicit in subdomain (blog.aspose.org, docs.aspose.org, etc.)
    - Section name NEVER appears in URL path
    - For V2 layout with default language (en), the URL format is:
      /<family>/<platform>/<slug>/

    Args:
        section: Section name (products, docs, reference, kb, blog) - used for
                 subdomain determination but NOT included in URL path
        slug: Page slug
        product_slug: Product family slug (e.g., "cells", "words")
        platform: Platform (e.g., "python", "java")
        locale: Language code (default: "en")

    Returns:
        Canonical URL path with leading and trailing slashes

    Examples:
        compute_url_path("docs", "getting-started", "cells", "python")
        => "/cells/python/getting-started/"  (NOT /cells/python/docs/getting-started/)

        compute_url_path("blog", "announcement", "3d", "python")
        => "/3d/python/announcement/"  (NOT /3d/python/blog/announcement/)
    """
    # Per specs/33_public_url_mapping.md:83-86, 106:
    # Section is implicit in subdomain, NOT in URL path
    # Format: /<family>/<platform>/<slug>/
    parts = [product_slug, platform, slug]

    # Build path with leading and trailing slashes
    url_path = "/" + "/".join(parts) + "/"
    return url_path
```

**What Changed**:
1. **Removed lines 403-404**: Deleted conditional logic that added section to URL path
2. **Simplified parts list**: Changed from `[product_slug, platform] + [section if section != "products" else []] + [slug]` to `[product_slug, platform, slug]`
3. **Enhanced docstring**: Added explanation that section is implicit in subdomain
4. **Added examples**: Included concrete examples showing correct URL format
5. **Updated Args documentation**: Clarified that section parameter is used for subdomain determination but NOT included in URL path

**Lines Changed**: 376-410 (entire function)

**Impact**: All URL paths generated by this function will now exclude the section name, matching the spec requirement.

---

## File 2: tests/unit/workers/test_tc_430_ia_planner.py

### Change 1: Updated test_compute_url_path_docs() (lines 354-364)

**BEFORE**:
```python
# Test 12: Compute URL path - docs section
def test_compute_url_path_docs():
    """Test URL path computation for docs section."""
    url = compute_url_path(
        section="docs",
        slug="getting-started",
        product_slug="3d",
        platform="python"
    )

    assert url == "/3d/python/docs/getting-started/"
```

**AFTER**:
```python
# Test 12: Compute URL path - docs section
def test_compute_url_path_docs():
    """Test URL path computation for docs section.

    Per specs/33_public_url_mapping.md:83-86, section is implicit in subdomain,
    NOT in URL path. URL should be /3d/python/getting-started/, not /3d/python/docs/getting-started/
    """
    url = compute_url_path(
        section="docs",
        slug="getting-started",
        product_slug="3d",
        platform="python"
    )

    # Section should NOT appear in URL path
    assert url == "/3d/python/getting-started/"
    assert "/docs/" not in url
```

**What Changed**:
- Updated expected URL from `/3d/python/docs/getting-started/` to `/3d/python/getting-started/`
- Added negative assertion to verify `/docs/` does NOT appear in URL
- Enhanced docstring with spec reference

### Change 2: Added test_compute_url_path_blog_section() (new test)

```python
# Test 12a: Compute URL path - blog section (no /blog/ in URL)
def test_compute_url_path_blog_section():
    """Test URL path computation for blog section.

    Per specs/33_public_url_mapping.md:106, blog section is implicit in subdomain
    (blog.aspose.org), NOT in URL path. Verify /blog/ does NOT appear in URL.
    """
    url = compute_url_path(
        section="blog",
        slug="announcement",
        product_slug="3d",
        platform="python"
    )

    # Section should NOT appear in URL path
    assert url == "/3d/python/announcement/"
    assert "/blog/" not in url, "Section 'blog' should NOT appear in URL path (it's implicit in subdomain)"
```

### Change 3: Added test_compute_url_path_docs_section() (new test)

```python
# Test 12b: Compute URL path - docs section (no /docs/ in URL)
def test_compute_url_path_docs_section():
    """Test URL path computation for docs section.

    Per specs/33_public_url_mapping.md:83-86, docs section is implicit in subdomain
    (docs.aspose.org), NOT in URL path. Verify /docs/ does NOT appear in URL.
    """
    url = compute_url_path(
        section="docs",
        slug="developer-guide",
        product_slug="cells",
        platform="python"
    )

    # Section should NOT appear in URL path
    assert url == "/cells/python/developer-guide/"
    assert "/docs/" not in url, "Section 'docs' should NOT appear in URL path (it's implicit in subdomain)"
```

### Change 4: Added test_compute_url_path_kb_section() (new test)

```python
# Test 12c: Compute URL path - kb section (no /kb/ in URL)
def test_compute_url_path_kb_section():
    """Test URL path computation for kb section.

    Per specs/33_public_url_mapping.md, kb section is implicit in subdomain
    (kb.aspose.org), NOT in URL path. Verify /kb/ does NOT appear in URL.
    """
    url = compute_url_path(
        section="kb",
        slug="troubleshooting",
        product_slug="cells",
        platform="python"
    )

    # Section should NOT appear in URL path
    assert url == "/cells/python/troubleshooting/"
    assert "/kb/" not in url, "Section 'kb' should NOT appear in URL path (it's implicit in subdomain)"
```

### Change 5: Fixed test_add_cross_links() URL paths (lines 456-484)

**BEFORE**:
```python
    pages = [
        {
            "section": "products",
            "url_path": "/3d/python/overview/",
            "cross_links": []
        },
        {
            "section": "docs",
            "url_path": "/3d/python/docs/guide/",
            "cross_links": []
        },
        {
            "section": "reference",
            "url_path": "/3d/python/reference/api/",
            "cross_links": []
        },
        {
            "section": "kb",
            "url_path": "/3d/python/kb/faq/",
            "cross_links": []
        },
        {
            "section": "blog",
            "url_path": "/3d/python/blog/announcement/",
            "cross_links": []
        }
    ]
```

**AFTER**:
```python
    pages = [
        {
            "section": "products",
            "url_path": "/3d/python/overview/",
            "cross_links": []
        },
        {
            "section": "docs",
            "url_path": "/3d/python/guide/",
            "cross_links": []
        },
        {
            "section": "reference",
            "url_path": "/3d/python/api/",
            "cross_links": []
        },
        {
            "section": "kb",
            "url_path": "/3d/python/faq/",
            "cross_links": []
        },
        {
            "section": "blog",
            "url_path": "/3d/python/announcement/",
            "cross_links": []
        }
    ]
```

**What Changed**: Removed section names from all URL paths in test data to match new URL format.

### Change 6: Fixed mock_run_config fixture (lines 188-198)

**BEFORE**:
```python
@pytest.fixture
def mock_run_config(mock_run_dir: Path) -> Dict[str, Any]:
    """Create mock run configuration."""
    return {
        "schema_version": "1.0",
        "run_id": "test_run_001",
        "github_repo_url": "https://github.com/aspose-3d/Aspose.3D-for-Python-via-.NET",
        "github_ref": "main",
    }
```

**AFTER**:
```python
@pytest.fixture
def mock_run_config(mock_run_dir: Path) -> Dict[str, Any]:
    """Create mock run configuration."""
    return {
        "schema_version": "1.0",
        "run_id": "test_run_001",
        "github_repo_url": "https://github.com/aspose-3d/Aspose.3D-for-Python-via-.NET",
        "github_ref": "main",
        "family": "test-family",  # Use non-colliding family name to avoid template issues
        "target_platform": "python",
    }
```

**What Changed**: Added `family` and `target_platform` fields to prevent URL collisions with existing blog templates.

### Change 7: Fixed test_execute_ia_planner_success assertion (line 698)

**BEFORE**:
```python
    assert page_plan["product_slug"] == "3d"
```

**AFTER**:
```python
    assert page_plan["product_slug"] == "test-family"  # Per mock_run_config fixture
```

**What Changed**: Updated assertion to match the new `family` value in mock_run_config.

---

## Test Results
All 33 tests pass after changes:
- 3 new tests added for blog/docs/kb sections
- 1 existing test updated (test_compute_url_path_docs)
- 2 test fixtures updated (mock_run_config, test_add_cross_links)
- 1 assertion updated (test_execute_ia_planner_success)

## URL Format Examples

### Before Fix (WRONG):
- Products: `/3d/python/overview/` ✅ (correct - products section not added)
- Docs: `/3d/python/docs/getting-started/` ❌ (wrong - has `/docs/`)
- Blog: `/3d/python/blog/announcement/` ❌ (wrong - has `/blog/`)
- KB: `/3d/python/kb/faq/` ❌ (wrong - has `/kb/`)
- Reference: `/3d/python/reference/api/` ❌ (wrong - has `/reference/`)

### After Fix (CORRECT):
- Products: `/3d/python/overview/` ✅
- Docs: `/3d/python/getting-started/` ✅
- Blog: `/3d/python/announcement/` ✅
- KB: `/3d/python/faq/` ✅
- Reference: `/3d/python/api/` ✅

**Key Insight**: Section is implicit in subdomain (blog.aspose.org, docs.aspose.org, etc.), so it should NEVER appear in the URL path itself.
